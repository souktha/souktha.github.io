<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="PCIe support and splash screen for DM814x U-Boot">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Adding PCIe support and bring up the boot splash screen to DM814x U-Boot | Soukthavy Sopha</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://souktha.github.io/software/dm814x_pcie/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="description" itemprop="description" content="PCIe support and splash screen for DM814x U-Boot">
<meta name="author" content="Soukthavy">
<link rel="prev" href="../dm814x_sata/" title="Adding SATA HD boot support to DM814x U-Boot" type="text/html">
<link rel="next" href="../../hardware/zybo-spi-slave/" title="Zynq Zybo SPI slave via EMIO" type="text/html">
<meta property="og:site_name" content="Soukthavy Sopha">
<meta property="og:title" content="Adding PCIe support and bring up the boot splash screen to DM814x U-Bo">
<meta property="og:url" content="http://souktha.github.io/software/dm814x_pcie/">
<meta property="og:description" content="PCIe support and splash screen for DM814x U-Boot">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-06-11T22:18:26Z">
<meta property="article:tag" content="software">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://souktha.github.io/">

                <span id="blog-title">Soukthavy Sopha</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>
            </li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Blog <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../software">Sofware</a>
                    </li>
<li>
<a href="../../hardware">Hardware</a>
                    </li>
<li>
<a href="../../misc">Misc</a>
            </li>
</ul>
</li>
<li>
<a href="https://github.com/souktha">My Github</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text storypage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Adding PCIe support and bring up the boot splash screen to DM814x U-Boot</a></h1>

        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>It is desirable to have some visual feedback to user during system boot up process especially if the system takes more
than few seconds to boot. For the Linux based set-top box that boot to the main GUI menu may take considerable
amount of time depending on the number of processes it needs to start. Some system may need to program the FPGA bitmask,
bring up the networking processes or bring up some externally connected devices. These steps add up to the total system boot up
time. For system with video support, it is a good practice to have video up as soon as possible so that the user
would know that the system is working and it is in the process of booting up the system. This is commonly known as
putting the boot splash screen during boot process.</p>
<!-- TEASER_END -->
<p>The TI8148 has the integrated PCIe support in it. The TI OMAP DM814x/AM287x evaluation platform (TI8148 EVM) also comes
with one PCIe connnector where the HBA can be attached; however, the TI's official released <em>u-boot-2010.06-psp04.00.01</em>
does not have PCIe support enable. The board that I am using for this demonstration is the derivation of TI EVM board
having a proprietary PCIe based video processor chips built in to the system. The video processor chip is capable of
processing 4K-3D video. It has two HDMI ports and it has the built-in video/audio processing unit. This post is not
about the integrated HDVPSS.</p>
<p>In order to put the splash screen at u-boot level, I have to do these things,</p>
<ul class="simple">
<li>Initialize PCIe PLL clocks subsytem.</li>
<li>Initialize PCIe RC (Root Complex).</li>
<li>Initialize the video processor HDMI subsystem.</li>
<li>Put up the splash screen with logo and status bar.</li>
</ul>
<div class="section" id="initialize-the-pcie-pll">
<h2>Initialize the PCIe PLL</h2>
<p>In reference to  <em>u-boot-2010.06-psp04.04.00.01</em> of EZSDK, the file <em>board/ti/ti8148/evm.c</em> has function <em>pcie_pll_config()</em> disable (commented out). It is understandable that the original author exercised the practice of not leaving free-running clock enable if no device
was using it. Since I will be using it, this function need to be enable to configure PCIE's PLL clock in the control module
(section 3 and 19.2.1 of [<a class="reference internal" href="#id1">1</a>]). The registers to be configured are PLLCFG0 to PLLCFG4 of the PCIe control
module (base offset is 4814_0000). I made some minor change for the board I am using, enabling MEAS
and enabling latch (50%).</p>
<pre class="code c"><a name="rest_code_2aefc64b526f43068c658abf3182ee4d-1"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">pcie_pll_config</span><span class="p">()</span>
<a name="rest_code_2aefc64b526f43068c658abf3182ee4d-2"></a><span class="p">{</span>
<a name="rest_code_2aefc64b526f43068c658abf3182ee4d-3"></a>        <span class="p">..</span>
<a name="rest_code_2aefc64b526f43068c658abf3182ee4d-4"></a>        <span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x70007017</span><span class="p">,</span> <span class="n">PCIE_PLLCFG0</span><span class="p">);</span> <span class="c1">//per 19.3.1.1.1 sprugz8b.pdf manual.</span>
<a name="rest_code_2aefc64b526f43068c658abf3182ee4d-5"></a>        <span class="cm">/*wait for ADPLL lock*/</span>
<a name="rest_code_2aefc64b526f43068c658abf3182ee4d-6"></a>        <span class="p">..</span>
<a name="rest_code_2aefc64b526f43068c658abf3182ee4d-7"></a><span class="p">}</span>
</pre>
<p>at the end of <em>pcie_pll_config()</em>, wait for PLL to phase-lock by polling PLLSTATUS bit 1. Also a call to the function should
be made in <em>prcm_init()</em>. This portion of code is only to
configure PLL, feeding clock to the PCIe subsytem. It is the first step to be done before configuring/enumeratating
the PCIe device. This PCIe PLL configuration must be done before the complete powerup sequence before the clock module
is locked out so it is made as part of SBL ie.. (min_config).</p>
</div>
<div class="section" id="initialize-pcie-root-complex">
<h2>Initialize PCIe Root Complex</h2>
<p>The PCIe configuration registers of this OMAP SoC start at 5100_0000. The PCIe module is based on Synopsis Designware
Core (DWC) and TI SERDES PHY. It can
operate in either endpoint (EP) or root complex (RC). The mode to be initialized for this purpose is RC mode. To do this
is to set RC mode(2) for PCIE_CFG(480h) of the control module, bring PCIe out of reset sequence and enable PCIe clock (
<em>CM_DEFAULT_PCI_CLKCTRL</em>, section 2.10.7 of [<a class="reference internal" href="#id1">1</a>]). Once the PCIe is out of stand-by mode, the PCIe link can be trained or
set-up. Because the PCIe module of this SoC is single lane (x1), the PCIe is configured for x1 before link training
is initiated. When link training is completed, the PCIe is configured as bridge device with outbound transaction
set for base address 2000_0000 (refers to 2.12.1 of [<a class="reference internal" href="#id4">4</a>]). Some part of the code,</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-1">  1</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-2">  2</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-3">  3</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-4">  4</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-5">  5</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-6">  6</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-7">  7</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-8">  8</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-9">  9</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-10"> 10</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-11"> 11</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-12"> 12</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-13"> 13</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-14"> 14</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-15"> 15</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-16"> 16</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-17"> 17</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-18"> 18</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-19"> 19</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-20"> 20</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-21"> 21</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-22"> 22</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-23"> 23</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-24"> 24</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-25"> 25</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-26"> 26</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-27"> 27</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-28"> 28</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-29"> 29</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-30"> 30</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-31"> 31</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-32"> 32</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-33"> 33</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-34"> 34</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-35"> 35</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-36"> 36</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-37"> 37</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-38"> 38</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-39"> 39</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-40"> 40</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-41"> 41</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-42"> 42</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-43"> 43</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-44"> 44</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-45"> 45</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-46"> 46</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-47"> 47</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-48"> 48</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-49"> 49</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-50"> 50</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-51"> 51</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-52"> 52</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-53"> 53</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-54"> 54</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-55"> 55</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-56"> 56</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-57"> 57</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-58"> 58</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-59"> 59</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-60"> 60</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-61"> 61</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-62"> 62</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-63"> 63</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-64"> 64</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-65"> 65</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-66"> 66</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-67"> 67</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-68"> 68</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-69"> 69</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-70"> 70</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-71"> 71</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-72"> 72</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-73"> 73</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-74"> 74</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-75"> 75</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-76"> 76</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-77"> 77</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-78"> 78</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-79"> 79</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-80"> 80</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-81"> 81</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-82"> 82</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-83"> 83</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-84"> 84</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-85"> 85</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-86"> 86</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-87"> 87</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-88"> 88</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-89"> 89</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-90"> 90</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-91"> 91</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-92"> 92</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-93"> 93</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-94"> 94</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-95"> 95</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-96"> 96</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-97"> 97</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-98"> 98</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-99"> 99</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-100">100</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-101">101</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-102">102</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-103">103</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-104">104</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-105">105</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-106">106</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-107">107</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-108">108</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-109">109</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-110">110</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-111">111</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-112">112</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-113">113</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-114">114</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-115">115</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-116">116</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-117">117</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-118">118</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-119">119</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-120">120</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-121">121</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-122">122</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-123">123</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-124">124</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-125">125</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-126">126</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-127">127</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-128">128</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-129">129</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-130">130</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-131">131</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-132">132</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-133">133</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-134">134</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-135">135</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-136">136</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-137">137</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-138">138</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-139">139</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-140">140</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-141">141</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-142">142</a>
<a href="#rest_code_d6ff81c69dc44a01bdd4494e70111aef-143">143</a></pre></div></td>
<td class="code"><pre class="code c"><a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-1"></a>       <span class="cm">/*Various regions in PCIESS address space, sprugz8d document section 19.2.4.1, fig 19.2*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-2"></a>       <span class="p">..</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-3"></a>       <span class="cp">#define SPACE0_LOCAL_CFG_OFFSET         0x1000  </span><span class="cm">/*local config space*/</span><span class="cp"></span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-4"></a>       <span class="cp">#define SPACE0_REMOTE_CFG_OFFSET        0x2000  </span><span class="cm">/*remote config space*/</span><span class="cp"></span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-5"></a>       <span class="cp">#define SPACE0_IO_OFFSET                0x3000  </span><span class="cm">/*remote device IO space*/</span><span class="cp"></span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-6"></a>       <span class="cp">#define PCIE_CONFIG_BASE                0x51000000</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-7"></a>       <span class="p">..</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-8"></a>       <span class="p">..</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-9"></a>       <span class="k">static</span> <span class="kt">void</span> <span class="n">set_outbound_trans</span><span class="p">(</span><span class="n">u32</span> <span class="n">start</span><span class="p">,</span> <span class="n">u32</span> <span class="n">end</span><span class="p">)</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-10"></a>       <span class="p">{</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-11"></a>       <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr_size</span><span class="p">;</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-12"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-13"></a>       <span class="cm">/*Set outbound translation size per window division*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-14"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="n">CFG_PCIM_WIN_SZ_IDX</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">OB_SIZE</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-15"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-16"></a>       <span class="n">tr_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">CFG_PCIM_WIN_SZ_IDX</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span> <span class="o">*</span> <span class="n">SZ_1M</span><span class="p">;</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-17"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-18"></a>       <span class="cm">/*Direct 1:1 mapping of RC &lt;-&gt; PCI memory space*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-19"></a>       <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">CFG_PCIM_WIN_CNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-20"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="n">start</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">OB_OFFSET_INDEX</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-21"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">OB_OFFSET_HI</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-22"></a>               <span class="n">start</span> <span class="o">+=</span> <span class="n">tr_size</span><span class="p">;</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-23"></a>       <span class="p">}</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-24"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-25"></a>       <span class="cm">/*Enable OB translation*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-26"></a>        <span class="n">__raw_writel</span><span class="p">(</span><span class="n">OB_XLAT_EN_VAL</span> <span class="o">|</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">CMD_STATUS</span><span class="p">),</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-27"></a>                        <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">CMD_STATUS</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-28"></a>       <span class="p">}</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-29"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-30"></a>       <span class="p">..</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-31"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-32"></a>       <span class="k">static</span> <span class="kt">void</span> <span class="n">set_inbound_trans</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-33"></a>       <span class="p">{</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-34"></a>       <span class="cm">/*Configure and set up BAR0*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-35"></a>       <span class="n">set_dbi_mode</span><span class="p">();</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-36"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-37"></a>       <span class="cm">/*Enable BAR0*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-38"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-39"></a>                       <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-40"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-41"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="n">SZ_4K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-42"></a>                       <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-43"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-44"></a>       <span class="n">clear_dbi_mode</span><span class="p">();</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-45"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-46"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="n">reg_phys</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-47"></a>                               <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-48"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-49"></a>       <span class="cm">/*Configure BAR1 only if inbound window is specified*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-50"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ram_base</span> <span class="o">!=</span> <span class="n">ram_end</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-51"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="n">ram_base</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">IB_START0_LO</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-52"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">IB_START0_HI</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-53"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">IB_BAR0</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-54"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="n">ram_base</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">IB_OFFSET0</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-55"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-56"></a>               <span class="n">set_dbi_mode</span><span class="p">();</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-57"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-58"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-59"></a>                               <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-60"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-61"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="n">ram_end</span> <span class="o">-</span> <span class="n">ram_base</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-62"></a>                       <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-63"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-64"></a>               <span class="n">clear_dbi_mode</span><span class="p">();</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-65"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-66"></a>               <span class="cm">/*Set BAR1 attributes and value in config space*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-67"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="n">ram_base</span> <span class="o">|</span> <span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">,</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-68"></a>                               <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-69"></a>                               <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-70"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-71"></a>               <span class="n">__raw_writel</span><span class="p">(</span><span class="n">IB_XLAT_EN_VAL</span> <span class="o">|</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg_virt</span> <span class="o">+</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-72"></a>                                       <span class="n">CMD_STATUS</span><span class="p">),</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">CMD_STATUS</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-73"></a>               <span class="p">}</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-74"></a>       <span class="p">}</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-75"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-76"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-77"></a>       <span class="k">static</span> <span class="kt">void</span> <span class="n">omap_pcie_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-78"></a>       <span class="p">{</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-79"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-80"></a>         <span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-81"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-82"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">CTRL_BASE</span> <span class="o">+</span> <span class="mh">0x480</span><span class="p">);</span> <span class="cm">/*RC mode*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-83"></a>       <span class="cm">/*bring PCIE out of reset sequence (PRM_DEFAULT)*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-84"></a>       <span class="n">__raw_writel</span><span class="p">(</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0xb10</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0xb10</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-85"></a>       <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-86"></a>       <span class="n">__raw_writel</span><span class="p">(</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0xb10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">,</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0xb10</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-87"></a>       <span class="n">delay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-88"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0xb14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">,</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0xb14</span><span class="p">);</span> <span class="c1">//clear this bit</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-89"></a>       <span class="n">delay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-90"></a>       <span class="cm">/*enable PCIE clock (CM_DEFAULT)*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-91"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0x578</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-92"></a>       <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-93"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-94"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0x510</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-95"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0x578</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-96"></a>       <span class="k">while</span> <span class="p">(</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">PRCM_BASE</span><span class="o">+</span><span class="mh">0x578</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x70000</span> <span class="p">)</span><span class="n">delay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-97"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="n">DIR_SPD</span> <span class="o">|</span> <span class="n">__raw_readl</span><span class="p">(</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-98"></a>                               <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PL_GEN2</span><span class="p">),</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-99"></a>                       <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PL_GEN2</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-100"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-101"></a>       <span class="cm">/*set x1*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-102"></a>       <span class="n">val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-103"></a>                       <span class="n">LINK_CAP</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-104"></a>       <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3f</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-105"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-106"></a>                       <span class="n">LINK_CAP</span><span class="p">);</span> <span class="cm">/*not to confuse, this is PCIESS local config reg, not PCIe config reg which is RO*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-107"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-108"></a>       <span class="n">val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PL_GEN2</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-109"></a>       <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-110"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PL_GEN2</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-111"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-112"></a>       <span class="n">val</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-113"></a>                       <span class="n">PL_LINK_CTRL</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-114"></a>       <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3F</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-115"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-116"></a>                               <span class="n">PL_LINK_CTRL</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-117"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-118"></a>       <span class="cm">/*Initiate Link Trainin*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-119"></a>        <span class="n">__raw_writel</span><span class="p">(</span><span class="n">LTSSM_EN_VAL</span> <span class="o">|</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">CMD_STATUS</span><span class="p">),</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-120"></a>                        <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">CMD_STATUS</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-121"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-122"></a>       <span class="n">udelay</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-123"></a>       <span class="cm">/*set up as bridge*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-124"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-125"></a>       <span class="n">__raw_writew</span><span class="p">(</span><span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">,</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-126"></a>                       <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_CLASS_DEVICE</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-127"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-128"></a>       <span class="n">disable_bars</span><span class="p">();</span> <span class="c1">//for now</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-129"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-130"></a>       <span class="n">set_outbound_trans</span><span class="p">(</span><span class="mh">0x20000000</span><span class="p">,</span> <span class="mh">0x30000000</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//non-prefetch mem area</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-131"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-132"></a>       <span class="cm">/*Enable 32-bit IO addressing support*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-133"></a>       <span class="n">__raw_writew</span><span class="p">(</span><span class="n">PCI_IO_RANGE_TYPE_32</span> <span class="o">|</span> <span class="p">(</span><span class="n">PCI_IO_RANGE_TYPE_32</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-134"></a>                       <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_IO_BASE</span><span class="p">);</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-135"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-136"></a>       <span class="cm">/*not plan to use interrupt*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-137"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span> <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">IRQ_ENABLE_CLR</span><span class="p">);</span> <span class="c1">//not enable irq</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-138"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-139"></a>       <span class="cm">/*skip MSI interrupt chain setup*/</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-140"></a>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-141"></a>       <span class="n">get_and_clear_err</span><span class="p">();</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-142"></a>       <span class="p">}</span>
<a name="rest_code_d6ff81c69dc44a01bdd4494e70111aef-143"></a>       <span class="p">..</span>
</pre></td>
</tr></table>
<p>The mapped BAR, 2000_0000 is the 256MB address space set aside for PCIe device's use [<a class="reference internal" href="#id4">4</a>].
This is corresponded to the  address of the downstream PCIe video chip. Accessing this address space after the mapping is to access the video processor chip (below snippet). For system with more than one PCIe devices, extra code for buses enumeration is needed. Shown here is for the simplest case, single PCIe device [<a class="reference internal" href="#id6">6</a>].</p>
<p>The next step is to set up the PCI header structure of u-boot so that it can be accessible by its drivers and utility. This
includes registering PCI device, its respective read/write configuration space handlers etc..
Post enumeration is to set up the inbound transaction address space which is the local system memory space of the system.</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-1"> 1</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-2"> 2</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-3"> 3</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-4"> 4</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-5"> 5</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-6"> 6</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-7"> 7</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-8"> 8</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-9"> 9</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-10">10</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-11">11</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-12">12</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-13">13</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-14">14</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-15">15</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-16">16</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-17">17</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-18">18</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-19">19</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-20">20</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-21">21</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-22">22</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-23">23</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-24">24</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-25">25</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-26">26</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-27">27</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-28">28</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-29">29</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-30">30</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-31">31</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-32">32</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-33">33</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-34">34</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-35">35</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-36">36</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-37">37</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-38">38</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-39">39</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-40">40</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-41">41</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-42">42</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-43">43</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-44">44</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-45">45</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-46">46</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-47">47</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-48">48</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-49">49</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-50">50</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-51">51</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-52">52</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-53">53</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-54">54</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-55">55</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-56">56</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-57">57</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-58">58</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-59">59</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-60">60</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-61">61</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-62">62</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-63">63</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-64">64</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-65">65</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-66">66</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-67">67</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-68">68</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-69">69</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-70">70</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-71">71</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-72">72</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-73">73</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-74">74</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-75">75</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-76">76</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-77">77</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-78">78</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-79">79</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-80">80</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-81">81</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-82">82</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-83">83</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-84">84</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-85">85</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-86">86</a>
<a href="#rest_code_31657ee43df2472b85fa1550014f3eeb-87">87</a></pre></div></td>
<td class="code"><pre class="code c"><a name="rest_code_31657ee43df2472b85fa1550014f3eeb-1"></a>       <span class="k">static</span> <span class="k">struct</span> <span class="n">pci_config_table</span> <span class="n">pci_redray_config_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-2"></a>       <span class="cm">/*104c,8888 - TI host bridge*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-3"></a>               <span class="p">{</span><span class="mh">0x104c</span><span class="p">,</span> <span class="mh">0x8888</span><span class="p">,</span> <span class="n">PCI_CLASS_BRIDGE_HOST</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-4"></a>                <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">pci_setup_ti_bridge</span><span class="p">},</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-5"></a>               <span class="p">{</span><span class="mi">0</span><span class="n">x</span><span class="p">...,</span> <span class="mi">0</span><span class="n">x</span><span class="p">...,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="cm">/*note: omit proprieatary info here*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-6"></a>                <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">pci_setup_vp</span><span class="p">},</span> <span class="cm">/*pci_setup_vp is to set up this proprietary video processor chip*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-7"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-8"></a>       <span class="p">{</span> <span class="p">}</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-9"></a>       <span class="p">};</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-10"></a>       <span class="p">..</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-11"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-12"></a>       <span class="k">struct</span> <span class="n">pci_controller</span> <span class="n">hose</span> <span class="o">=</span> <span class="p">{</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-13"></a>               <span class="nl">config_table</span><span class="p">:</span> <span class="n">pci_vp_config_table</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-14"></a>       <span class="p">};</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-15"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-16"></a>       <span class="p">..</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-17"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-18"></a>       <span class="kt">void</span> <span class="n">omap_pci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span><span class="o">*</span> <span class="n">hose</span><span class="p">)</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-19"></a>       <span class="p">{</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-20"></a>       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span><span class="n">offset</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-21"></a>       <span class="n">pci_dev_t</span> <span class="n">dev</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-22"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-23"></a>       <span class="n">omap_pcie_setup</span><span class="p">();</span><span class="c1">//as shown above</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-24"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-25"></a>       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-26"></a>       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-27"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-28"></a>       <span class="cm">/*memory space*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-29"></a>       <span class="n">pci_set_region</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-30"></a>                       <span class="mh">0x20000000</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-31"></a>                       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1900000</span><span class="p">,</span> <span class="n">PCI_REGION_MEM</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-32"></a>       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-33"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-34"></a>       <span class="cm">/*PCI memory space*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-35"></a>       <span class="n">pci_set_region</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-36"></a>                       <span class="mh">0x20b00000</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-37"></a>                       <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="n">PCI_REGION_PREFETCH</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-38"></a>       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_prefetch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-39"></a>       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-40"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-41"></a>       <span class="cm">/*PCI I/O space*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-42"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-43"></a>       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">region_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-44"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-45"></a>       <span class="n">pci_register_hose</span> <span class="p">(</span><span class="n">hose</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-46"></a>       <span class="n">pci_set_ops</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-47"></a>                   <span class="n">pci_hose_read_config_byte_via_dword</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-48"></a>                   <span class="n">pci_hose_read_config_word_via_dword</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-49"></a>                   <span class="n">ti81xx_pci_read_config</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-50"></a>                   <span class="n">pci_hose_write_config_byte_via_dword</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-51"></a>                   <span class="n">pci_hose_write_config_word_via_dword</span><span class="p">,</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-52"></a>                   <span class="n">ti81xx_pci_write_config</span> <span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-53"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-54"></a>       <span class="n">pciauto_config_init</span><span class="p">(</span><span class="n">hose</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-55"></a>       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">current_busno</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-56"></a>       <span class="n">dev</span> <span class="o">=</span> <span class="n">PCI_BDF</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-57"></a>       <span class="n">pciauto_prescan_setup_bridge</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span><span class="n">dev</span><span class="p">,</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">current_busno</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-58"></a>       <span class="n">pciauto_setup_device</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span><span class="n">dev</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem</span><span class="p">,</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_prefetch</span><span class="p">,</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_io</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-59"></a>       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span> <span class="o">=</span> <span class="n">pci_hose_scan</span><span class="p">(</span><span class="n">hose</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-60"></a>       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">current_busno</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-61"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-62"></a>       <span class="cm">/*fix up*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-63"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x20800000</span><span class="p">,</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_REMOTE_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-64"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x20000000</span><span class="p">,</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_REMOTE_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-65"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x010130</span><span class="p">,</span>  <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_REMOTE_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-66"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x100546</span><span class="p">,</span>  <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_REMOTE_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_COMMAND</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-67"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-68"></a>       <span class="cm">/*fix up max read request*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-69"></a>       <span class="n">offset</span> <span class="o">=</span>  <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_REMOTE_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_CAPABILITY_LIST</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-70"></a>       <span class="n">val</span> <span class="o">=</span>  <span class="n">__raw_readl</span><span class="p">(</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_REMOTE_CFG_OFFSET</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-71"></a>       <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span> <span class="cm">/*max read requst mask is 256bytes/read*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-72"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span>  <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_REMOTE_CFG_OFFSET</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-73"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-74"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x100147</span><span class="p">,</span>  <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_REMOTE_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_COMMAND</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-75"></a>       <span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x100147</span><span class="p">,</span>  <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span> <span class="n">PCI_COMMAND</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-76"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-77"></a>       <span class="n">ram_base</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-78"></a>       <span class="n">ram_end</span> <span class="o">=</span> <span class="n">ram_base</span> <span class="o">+</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-79"></a>       <span class="cm">/*Post enumeration fixups*/</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-80"></a>       <span class="n">set_inbound_trans</span><span class="p">();</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-81"></a>       <span class="n">__raw_writew</span><span class="p">(</span><span class="n">__raw_readw</span><span class="p">(</span><span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-82"></a>                               <span class="n">PCI_IO_BASE</span><span class="p">)</span> <span class="o">|</span> <span class="n">PCI_IO_RANGE_TYPE_32</span> <span class="o">|</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-83"></a>                               <span class="p">(</span><span class="n">PCI_IO_RANGE_TYPE_32</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-84"></a>                               <span class="n">reg_virt</span> <span class="o">+</span> <span class="n">SPACE0_LOCAL_CFG_OFFSET</span> <span class="o">+</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-85"></a>                               <span class="n">PCI_IO_BASE</span><span class="p">);</span>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-86"></a>
<a name="rest_code_31657ee43df2472b85fa1550014f3eeb-87"></a>       <span class="p">}</span>
</pre></td>
</tr></table>
<p>When all is done with PCIe device configuration, the device's PCIe memory mapped address space can be dumped with
u-boot's <em>md</em> command. Sample below is the content of the video processor control registers area.</p>
<pre class="code console"><a name="rest_code_9e701c49e12a4f3497babde9df4faa12-1"></a><span class="go">TI-MIN#md 20000000</span>
<a name="rest_code_9e701c49e12a4f3497babde9df4faa12-2"></a><span class="go">20000000: 00000000 00000000 00000000 00000000    ................</span>
<a name="rest_code_9e701c49e12a4f3497babde9df4faa12-3"></a><span class="go">20000010: 00000000 00000000 00000000 00000000    ................</span>
<a name="rest_code_9e701c49e12a4f3497babde9df4faa12-4"></a><span class="go">20000020: 00000000 00000000 00000000 00000000    ................</span>
<a name="rest_code_9e701c49e12a4f3497babde9df4faa12-5"></a><span class="go">20000030: 00000000 00000000 00000000 00000035    ............5...</span>
<a name="rest_code_9e701c49e12a4f3497babde9df4faa12-6"></a><span class="go">20000040: 000003e7 0000000e 0000000f 00000000    ................</span>
<a name="rest_code_9e701c49e12a4f3497babde9df4faa12-7"></a><span class="go">20000050: 00000000 00000011 00000035 000003e7    ........5.......</span>
<a name="rest_code_9e701c49e12a4f3497babde9df4faa12-8"></a><span class="go">20000060: 0000000e 0000000f 00000000 00000000    ................</span>
</pre>
<p>TI document section 19.3.1 [<a class="reference internal" href="#id1">1</a>] describes all the necessary steps needed to set up the RC mode for this module. Initialization of PCIESS for
the boot code or the high level kernel OS takes the exact same steps. In fact, I ported part of the code from the linux kernel originally
done by TI [<a class="reference internal" href="#id3">3</a>] in <em>linux-2.6,37-psp04.04.00.01/mach-omap2/pcie-ti81xx.c</em>.</p>
</div>
<div class="section" id="initialize-the-video-processor-s-hdmi-subsystem">
<h2>Initialize the video processor's HDMI subsystem</h2>
<p>From this point onward, the PCIe video processor is accessible by u-boot. The proprietary video processor used
in this derived platform has external DDR3 video display memory that need to be configured. The first step in this
process is to set up its PLL clocks subsystem and set up its DDR3 memory controller (DDR training). Video PLL clock and audio
PLL clock are set up as part of this initialization. Following this step, the EDID is read from the connected
display device (monitor/tv) so that it can setup the HDMI interface correctly. My board's HDMI is connected to ASUS
LCD monitor.</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="#rest_code_d404200dbe054754bef1e651638e8965-1"> 1</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-2"> 2</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-3"> 3</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-4"> 4</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-5"> 5</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-6"> 6</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-7"> 7</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-8"> 8</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-9"> 9</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-10">10</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-11">11</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-12">12</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-13">13</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-14">14</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-15">15</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-16">16</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-17">17</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-18">18</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-19">19</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-20">20</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-21">21</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-22">22</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-23">23</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-24">24</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-25">25</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-26">26</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-27">27</a>
<a href="#rest_code_d404200dbe054754bef1e651638e8965-28">28</a></pre></div></td>
<td class="code"><pre class="code console"><a name="rest_code_d404200dbe054754bef1e651638e8965-1"></a><span class="go">       U-Boot 2010.06 (Jul 02 2016 - 17:35:59)</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-2"></a>
<a name="rest_code_d404200dbe054754bef1e651638e8965-3"></a><span class="go">       TI8148-GP rev 2.1</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-4"></a>
<a name="rest_code_d404200dbe054754bef1e651638e8965-5"></a><span class="go">       ARM clk: 720MHz</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-6"></a><span class="go">       DDR clk: 533MHz</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-7"></a>
<a name="rest_code_d404200dbe054754bef1e651638e8965-8"></a><span class="go">       I2C:   ready</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-9"></a><span class="go">       DRAM:  2 GiB</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-10"></a><span class="go">       NAND:  HW ECC BCH8 Selected</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-11"></a><span class="go">       256 MiB</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-12"></a>
<a name="rest_code_d404200dbe054754bef1e651638e8965-13"></a><span class="go">       ..</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-14"></a>
<a name="rest_code_d404200dbe054754bef1e651638e8965-15"></a><span class="go">       DDR trained (0x80000fff).</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-16"></a>
<a name="rest_code_d404200dbe054754bef1e651638e8965-17"></a><span class="go">       Pixel clocks  :148500 KHZ</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-18"></a><span class="go">       Horizontal pix:1920</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-19"></a><span class="go">       Vertical   pix:1080</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-20"></a><span class="go">       Display size H:598 mm</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-21"></a><span class="go">       Display size V:592 mm</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-22"></a><span class="go">       Display Name     : VS278</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-23"></a><span class="go">       Display serial no: D1LMQS148212</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-24"></a>
<a name="rest_code_d404200dbe054754bef1e651638e8965-25"></a><span class="go">       MMC:   OMAP SD/MMC: 0</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-26"></a><span class="go">       Net:   Detected MACID:2c:b6:9d:d0:d1:d2</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-27"></a><span class="go">       cpsw</span>
<a name="rest_code_d404200dbe054754bef1e651638e8965-28"></a><span class="go">       Hit any key to stop autoboot:  1</span>
</pre></td>
</tr></table>
<p>The information from EDID is used for configuring the HDMI [<a class="reference internal" href="#id5">5</a>] to match the capability of the display unit (TV/monitor) so that
the splash screen will be properly centered. The gamma LUT, chroma scaler, dithering frame dimension, info frame, color space
etc.. for the video pipe and the HDMI component of the video processor are then initialized accordingly.</p>
</div>
<div class="section" id="put-up-splash-screen-logo">
<h2>Put up splash screen logo</h2>
<p>The final step is to load the video pixels of the splash screen. One is static logo image and one is the progressive
status bar. The logo image that is compiled along u-boot code (~100k) is then DMAed by the video processor to its
layered output display memory buffer, the main display buffer. The overlay progressive status bar is output in the
same way, but to its OSD display buffer and having its progress status update mechanism hooks up to the timer tick
in order to update the progress bar. This part of putting the splash screen is the proprietary part that I cannot
include any snippet due to NDA.</p>
<div class="figure">
<img alt="../../images/misc/splash-screen.jpg" src="../../images/misc/splash-screen.jpg"><p class="caption">Splash screen with a progressing status bar (company logo blocked out).</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>It takes a little bit of effort to get this done, coding and debugging, but some lessons are learned during the
process.</p>
<div class="section" id="citations">
<h3>Citations</h3>
<table class="docutils footnote" frame="void" id="id1" rules="none">
<colgroup>
<col class="label">
<col>
</colgroup>
<tbody valign="top"><tr>
<td class="label">[1]</td>
<td>TMS320DM814x Davinci Digital Video Processor Technical Reference Manual, SPRUGZ8D, Revised April 2013.</td>
</tr></tbody>
</table>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup>
<col class="label">
<col>
</colgroup>
<tbody valign="top"><tr>
<td class="label">[2]</td>
<td>arm-2009q1-203-arm-none-linux-gnueabi.bin, TI cross toolchain.</td>
</tr></tbody>
</table>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup>
<col class="label">
<col>
</colgroup>
<tbody valign="top"><tr>
<td class="label">[3]</td>
<td>LINUXEZSDK-DAVINCI: Linux EZ Software Development Kit (EZSDK) for DM814x and DM816x- ALPHA,ezsdk_dm814x-evm_5_05_01_04_setuplinux, www.ti.com/tool/linuxezsdk-davinci, v5.05.01.04-ALPHA, 10 OCt, 2012.</td>
</tr></tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup>
<col class="label">
<col>
</colgroup>
<tbody valign="top"><tr>
<td class="label">[4]</td>
<td>TMS320DM8148, TMS320DM8148, TMS320DM8146, SPRS647D-MARCH 2011-REVISED SEPTEMBER 2012.</td>
</tr></tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup>
<col class="label">
<col>
</colgroup>
<tbody valign="top"><tr>
<td class="label">[5]</td>
<td>High Definition Multimedia Interface, Specification Version 1.3a, November 10, 2006</td>
</tr></tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup>
<col class="label">
<col>
</colgroup>
<tbody valign="top"><tr>
<td class="label">[6]</td>
<td>PCI Express System Architecture, MindShare Inc, Addison Wesley, ISBN: 0-321-15630-7, September 04, 2003.</td>
</tr></tbody>
</table>
</div>
</div>
</div>
    </div>
    

</article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2017         <a href="mailto:soukthavy@yahoo.com">Soukthavy</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
